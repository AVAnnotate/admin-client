---
import Layout from '@layouts/Layout.astro';
import { getLangFromUrl } from '@i18n';
import { userInfo } from '@backend/userInfo';
import { initFs } from 'src/lib/memfs';
import { gitRepo } from '@backend/gitRepo';
import { getTranslations } from '@i18n';
import { Projects } from '@apps/Projects';

import '@themes/default/index.css';

const lang = getLangFromUrl(Astro.url);

const i18n = getTranslations(Astro.request, 'projects');
const accessCookie = Astro.cookies.get('access-token');

console.log('Access token: ', accessCookie?.value);

const info = await userInfo(Astro.cookies);

console.log('info: ', info);
if (!info) {
  console.log('Redirecting: ', lang);
  return Astro.redirect(`/${lang}/sign-in`);
}

const fs = initFs('avannotate');

const { readFile } = await gitRepo({
  fs: fs,
  workingDir: '/',
  repositoryURL: import.meta.env.GIT_REPO_ADMIN,
  proxyUrl: import.meta.env.PROXY_URL,
  userInfo: info,
});

console.log('Repo accessed!');

// await fs.promises.readdir('/').then((res) => console.log('Read dir: ', res));
const projs = await readFile(fs, '/', 'data/projects.json');
const projects = JSON.parse(projs as string);
---

<Layout title='Projects' profile={info.profile}>
  <Projects projects={projects.projects} i18n={i18n} client:only='react' />
</Layout>
